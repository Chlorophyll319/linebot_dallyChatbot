# 亂七八糟的碎碎念中心

## 目前進度

v（打勾）：完成 ｜ -：正在製作中 ｜ d（delay）：想做但還沒開始 ｜ f（failed）：失敗

---

6/2

- 規劃.md
- [v] 已確認主題，擴展初稿
- [-] 找適合的api，並分類內容

6/3

- 規劃.md
- [v] 新增各主題目的、顯示格式、api連結
- [v] 新增各api連結
- api連結的內容
- [v] api名字、api主要欄位說明、api更新頻率
- 顯示格式
- [d] 內容
- 小機器人區塊
- [v] 功能區分
- [v] 回話話術規劃
- [v] 介紹&實際表現
- [v] LINE選單初步規劃

6/4

- [-] 設計檔案結構
- [-] 不知道哪裡錯了，重建環境
- 規劃.md
- 小機器人
- [v] 更改LINE選單初步規劃(v2)

6/5

- [v] 建立檔案夾&檔案
- /data/info
- [v] 新增淺草100籤的json檔
- [v] 串淺草100籤本地api
- weatherApi.js(v1)
- [v] 串api 每一隻都串網址，使用具名匯出
- 改做apiList.json管理api
- [v] apiList.json(v1) 欄位：apiName、url
- [v] apiList.json(v2) 新增欄位 apifunc 與 apiFormat
- 改用物件串api
- weatherApi.js(v2)
- [v] 串api 每一隻都串json內容，使用具名匯出
- weatherApi.js(v3)
- [f] 試圖用迴圈串，但失敗了
  →回退進度到(v2)

6/6

- [v] 建立碎碎念.md，某種意義上來說是個備忘錄
- 碎碎念.md
- [v] 目前進度（新增至6/6）（碎碎念寫在目前進度裡面）
- [v] 問號紀錄（每個檔案裡面內心的疑惑大總和）
- [v] 目前規劃區塊（新增並填寫：資料夾目錄、各資料夾用途、流程規劃、）
- 碎碎念
- 感覺一直在改apiList.json跟wheatherApi.js，很想用一個迴圈之類的讓它自動幫我串好，但好像每次呼叫API的時候全部都會一起呼叫（連沒用到的都會）
  不確定能不能達成我想要的效果
  原本以為星期五做的完結果今天已經星期五了，我完全停留在星期三的進度中，說好先做出來再說呢QQ
- [v] 繼續嘗試一次串所有api，並試圖讓其可以不會每次都一次呼叫全部
- Tool.js
- [v] 新增 function buildApi
- weatherApi.js(v3)
- [v] 使用新寫法，呼叫 buildApi 並手動命名各個 function ，各自具名匯出
- 碎碎念
  終於從 weatherApi 的無限輪迴中逃出來ㄌ TDT
- [v] 在 /api 新增 檔案 googleCloudNaturalLanguage.js （未決定是否啟用）
- 開始寫 資料處理工廠 與 天氣迷你機器人
- 資料處理工廠
- [-] weatherTool.js
- 迷你機器人
- [-] miniBot-weather.js
- 碎碎念
- 好難，好複雜，感覺是物件的概念那邊出問題@@嗎？也許？我快不行了，今天感覺什麼都沒做，omg一天就這樣過去了
  自己設的變數跟的api裡面的key全部一坨黏在一起😱😱😱人生好難好可怕

6/7

- 重構apiList.json與API清單.md
- [-] 增加一週天氣預報
- 碎碎念
  沒想到之前找到的那個是每週平均，而不是一週每天各是多少，又要重新找API
- apiList.json(v2)
- [v] 增加一週每天各縣市天氣預報api（一般天氣預報）
- [v] 增加各縣市天氣預報官方提醒api(天氣預報小幫手)
- API清單.md(v2)
- [v] 增加一週每天各縣市天氣預報api（一般天氣預報）
- [v] 增加各縣市天氣預報官方提醒api(天氣預報小幫手)
- 碎碎念
  沒想到又要回來這個無限輪迴中了TAT，為什麼朋友沒有規劃就沒事，我沒規劃就有事啦（噴淚
- 統一把所有 .json 改成 .js 並將其內容變成 模組化+預設匯出
- [v] apiList.json → apiList.js
- [v] AsakusaFortuneTelling.json → AsakusaFortuneTelling.js
- [v] friends.json → friends.js
- [v] 已全部改完:）
- weatherTool.js
- [v] 重改 function buildApi（增加防呆機制避免有錯找不到，修改報錯機制讓其更清楚）
- [v] 增加一個叫做「 JSDoc 」的東西，寫給別人看的註解
- 碎碎念
  bug就跟消業障一樣@@ 都是前方累積的東西，不經常debug的話業障就會越來越多，時不時就要去消一下業障
- weatherApi.js
- [v] 裡面增加測試程式碼
- 碎碎念
  在寫程式的時候，除錯log資料要清楚標示，如果這裡錯了我會需要什麼資訊來除錯
  很難判斷但要練習一下@@ 或是等下問gpt通常是什麼樣的錯，寫完一部分就捉一次蟲，不要一整坨寫完再弄，會搞死自己

6/7

- 碎碎念.md
- [v] 新增 目前MVP 區塊
- weatherTool.js
- [-] 建造 一週天氣預報 資料處理工廠
- 碎碎念
- 有點困難，我先把預期結果寫下來好了
- miniBot-weather.js
- [v] 新增註解 預期要拿到的東西 及 預期處理後的成品
- weatherTool.js
- [-] 新增註解，Api的結構
- 碎碎念
- 橘子要看我在幹嘛，整理整理上傳GitHub
- [v] git 提交訊息
  🚧 重構 API 結構與資料模組，整合工具與資料來源

  - 🔧 將 apiList.json 改寫為 apiList.js，並導入 apiFunc 函式名稱欄位
  - ✨ 新增 buildApi 工具函式，讓所有 API 具名匯出更一致
  - 🧼 重命名與拆分 API 模組（如 AsakusaFortuneTelling、UV、googleCloudNL）
  - 🗃️ 資料夾與檔案重整：刪除不再使用的 json，改以 JS 匯出資料
  - 🤖 miniBot-weather.js、miniBot-QA.js 調整對應新的工具與 API 結構
  - 📄 新增規劃與備忘文檔：API 清單、碎碎念、思考紀錄
  - 更新git
  - [v] git 提交訊息
    🌀 整理一週天氣預報 MVP 功能邏輯 × 補上預期說明與註解
    - ✏️ 更新 linebot 總覽規劃文件，補完選單項目（定案版）
    - 🧠 `碎碎念.md` 新增 MVP 區塊、拆解資料預期與處理邏輯
    - 🛠 `weatherTool.js` 補上 JSDoc 註解，標示 api 結構與參數
    - 🧪 `miniBot-weather.js` 加上預期輸出說明，標示資料進出流程
    - 🔍 `weatherApi.js` 改寫處理流程、補上備忘註解，開工 `apiCity()`
    - 🧹 清理舊註解與暫存區塊，讓 code 閱讀更清晰
  - 碎碎念
    今天根本就都在讀Api QQ
    啥都沒寫QQ
    但是找到一個很讚的東西（天氣Api的資訊補充檔案）
  - 更新git
    📦 擴充一週天氣預報邏輯 × 調整結構與說明補強
    - 🧠 `碎碎念.md`：補充 git 區段，紀錄今天的進度與目前困惑
    - 🧪 `miniBot-weather.js`：補上「氣象感受解釋區塊」，擴寫話術範例與註解
    - 🛠 `weatherTool.js`：補齊預報結構說明，擴充資料抓取邏輯與註解層級
    - 🔧 調整內部註解層次與欄位分類，補上氣象元素抓取流程

  6/10

  - [-] 重新整理代辦清單

  6/13

  - [-] 設計friends檔案
  - 決定仿 mongoDB 的結構與形式，未來上線再建立線上儲存庫
  - [-] 新增函式資料夾

  6/14

  - [-] 資料處理工廠
  - 碎碎念
    這天幾乎沒做什麼事情，又在看api，進度停滯中。一邊查可行方案一邊走的感受真的很糟，下次要先規劃好
    繼續還業障

  6/17

  - 碎碎念
    荒廢了幾天終於又開始做小機器人了TT但其實中間還有做番茄鐘、bootstap也不算在摸魚啦XDDD（應該
  - [v] 使用google sheet取代friends.js作為資料庫

  6/19

  - 碎碎念
    超級大進展！！！！更新git紀錄一下
    資料處理工廠這樣也算是完成一半了QDQ
  - [v] 更新git
    📊 串接 Google Sheet × 取代暫存地點邏輯 × 預報流程完成測試
    🧩 `google-spreadsheet` 套件成功加入，完成 `sheetDB.js` 儲存/讀取邏輯
    🧪 `weatherTool.js` 串接地點預設值，完成 `reformToAWeek()` 測試流程
    🗃️ `friends.js` 移除暫時版本，正式改由 Sheet 操作 `defaultCity`
    🧠 `weatherTalkMap.js` + `weatherNum.js` 整合天氣代碼與應對話術
    🧹 `Tool.js` 清理測試 log，保留必要回傳驗證語句
    🔧 `package.json` & `package-lock.json` 新增 `google-spreadsheet` 依賴
    ✅ 本次整合完成預報資料從 API → 城市定位 → 分類轉換 → 話術輸出之完整流程
  - [v] 交差版的資料處理工廠完成了！！！
  - 更新git
    🧩 重構天氣資料處理流程 × 合併每日預報描述 × 整合成回傳語句  
    🔄 `splitByDate()` 回傳值從物件轉換為陣列，便於後續逐筆處理  
    ✨ 新增 `reformTwaWeekByDay()`：每日組合描述、調用時間格式化函式  
    🛠 `reformTwaWeekByTime()`：拆解早晚氣象資訊，產出氣象描述文字  
    🧪 `testFunc()` 測試流程更新，改用新版函式組合結果  
    🧼 清除暫時測試 log 與註解，回傳結構改為文字陣列 `botSay` 字串輸出
    📌 本次為資料清洗階段完工點，整合每日預報內容格式化為最終字串輸出

## 問號紀錄

- weatherApi.js

??是否需要return
??可以export那麼多東西嗎@@ 我依稀記得好像什麼時候可以很多個麼時候只能一個來著@@
??能不能跑迴圈自動串啊@@，function名字能不能自動串上ㄋ目前還是手動的有點風險，但暫時先不管，我先弄其他的東西回頭再來研究
??加入測試程式碼，還為研究意思，測試流程↓

1. 要加測試程式碼
   例如：console.log(內容)

2. 在終端機打上（node.js環境） node （/資料夾名稱…/檔案.檔名）
   ↑從專案資料夾開始算，不需要打專案資料夾

- miniBot-weather.js

??import { 全台1W天氣預報 } from "../api/weatherApi.js"; 這句裡面的 { ??? } 是什麼意思@@，這裡的{}跟一般的{}不一樣嗎？
??

- weatherTool.js

??資料處理工廠要怎麼建造@@

- apiList.js匯入???Api.js時要這樣寫

?? 這兩行看不懂為何用這個方式匯入

```const apiList = getApiList();
const Name = apiList["天氣預報"];
```

寫錯ㄉ地方↓
user.cityIndex()
不能這樣寫，正確寫法是↓

```
cityIndex[user.city]
```

- Tool.js

??JSDoc是啥？用途？格式？
@param {資料型態} 變數 - 說明
??@param是什麼？
??在寫程式的時候，除錯log資料要清楚標示，如果這裡錯了我會需要什麼資訊來除錯

- 測試用程式碼

// 如果是直接執行這個檔案，就測試 askGod()
if (import.meta.url === `file://${process.argv[1]}`) {
console.log("📿 問神中...");
const result = askGod();
console.dir(result, { depth: null });
}

- friends.js 決定用本地檔仿 MongoBD
  ↓需多出一個函式檔案

  📁 utils
  └─ friendDB.js ← 放模擬的資料庫函式
  📁 data
  └─ info
  └─ friends.json ← 模擬 MongoDB 的 collection

```
// utils/friendDB.js
const fs = require("fs");
const path = require("path");

const DB_PATH = path.join(__dirname, "../data/info/friends.json");

function loadDB() {
  if (!fs.existsSync(DB_PATH)) return [];
  const raw = fs.readFileSync(DB_PATH, "utf8");
  return JSON.parse(raw);
}

function saveDB(data) {
  fs.writeFileSync(DB_PATH, JSON.stringify(data, null, 2), "utf8");
}

// ⛏ 查詢使用者資料（模擬 findOne）
function getFriendData(userId) {
  const db = loadDB();
  return db.find((f) => f.userId === userId) || null;
}

// 🔧 儲存 / 更新資料（模擬 updateOne + upsert）
function saveFriendData(userId, field, value) {
  const db = loadDB();
  const user = db.find((f) => f.userId === userId);

  if (user) {
    user[field] = value;
  } else {
    db.push({ userId, [field]: value });
  }

  saveDB(db);
}

module.exports = {
  getFriendData,
  saveFriendData,
};

```

- weatherTool.js

```
export function parseTwAweek(userSet) {
  // 地點
  const userPlace = userSet.locationName;
  // 天氣現象 wx
  const wxArray =
    userSet.weatherElement.find((e) => e.elementName === "Wx")?.time || [];
  // 最高溫與最低溫
  const minTArray =
    userSet.weatherElement.find((e) => e.elementName === "MinT")?.time || [];
  const maxTArray =
    userSet.weatherElement.find((e) => e.elementName === "MaxT")?.time || [];
  return {
    userPlace,
    wxArray,
    minTArray,
    maxTArray,
  };
}
```

時間處理函式

```

```

| 比較項目     | `moment`                        | `date-fns`             |
| ------------ | ------------------------------- | ---------------------- |
| 歷史悠久     | ✅ 非常普遍                     | ✅ 越來越流行          |
| 檔案大小     | ❌ 比較大（整包）               | ✅ 小很多（模組化）    |
| 本地語系支援 | ✅ 很完整（預設含 zh-TW）       | ✅ 要額外匯入 locale   |
| 語法風格     | OOP 風格 `.format()`            | 函式風格 `format(...)` |
| 官方建議     | 🔚 停止更新中（已進入維護模式） | ✅ 持續活躍開發        |

- sheetDB.js

這個檔案需要研究@@

---

## 目前規劃

### MVP版本

1. 選單內容

- 一週（7天）天氣預報
- 三天內天氣預報
- 最近假期
- 求問淺草籤
- 擲杯
- 設定天氣預報的預設地點

2. 小機器人

- 話術
  - 顧左右而言他系列
  - 窩不知道系列

### 資料夾目錄

```
📁 api                // 各主題的 API 請求封裝（axios get, return 資料）
📁 Constants          // 全域可重用的靜態參數（關鍵字、選單設定等）
📁 data               // 各種靜態資料與話術模板
    ├─ info           // 全域通用資料（api 清單、用戶地點設定等）
    └─ miniBotPhrases // 小機器人對話語料（含 daily/weather 話術）
📁 Library            // 共用工具函式（格式轉換、資料驗證、分析等）
📁 MessageMockup      // 統一管理所有 Flex / Template Message 模板格式
📁 Module             // 各主題的「迷你機器人」邏輯模組（功能分工處理）
📄 index.js           // 主控制器，接收 LINE 訊息並轉交對應 Module
```

---

### 各資料夾用途

#### 1️⃣ `api/`

> 負責與外部 API 溝通，包含 axios 請求、try/catch、return 資料

| 檔名                            | 功能說明                      |
| ------------------------------- | ----------------------------- |
| `weatherApi.js`                 | 天氣預報、觀測、警報等API     |
| `airApi.js`                     | 空氣品質系列 API              |
| `climateApi.js`                 | 長期氣候報告                  |
| `earthquakeApi.js`              | 有感地震/震度觀測 API         |
| `holidayApi.js`                 | 放假資訊、災害停班課 API      |
| `randomTalks.js`                | 小機器人隨機回應/話術支援     |
| `googleCloudNaturalLanguage.js` | Google的語意判斷api（未定案） |

---

#### 2️⃣ `Constants/`

> 存放常用靜態設定，如選單項目、關鍵字對照表

- `botSay.js`：靜態話術回應（可能含隨機語句）
- `lineMenu.js`：LINE 選單結構
- `messageKeyword.js`：觸發語句、對話關鍵字

---

#### 3️⃣ `data/`

> 所有純資料定義、靜態檔、json 格式話術資料

🔹 `info/`

| 檔案           | 說明                          |
| -------------- | ----------------------------- |
| `apiList.json` | 各主題所有 API 的資料、分類   |
| `friends.json` | 使用者地點/偏好等個人設定資料 |

🔹 `miniBotPhrases/`

> 依小機器人主題分類話術（支援動態語句）

- `daily/`

  - `static.json`：靜態語氣話術（ex:「窩不知道！」）
  - `template.json`：動態語句模板（ex:「今天溫度是 {\$} 度，好冷喔！」）

- `weather/`（目前未展開，預留主題用）

---

#### 4️⃣ `Library/`

> 資料處理工廠：資料整理、格式轉換、驗證、抽出需要欄位等

- `tool.js`：通用工具整合包（包含 parser, validator 等）
- `weatherTool.js`：天氣資料專屬轉換工具
- `xmlRssTool.js`：RSS / XML 資料解析器
- `capNoScoolNoWorkTool.js`：災害停班停課資料處理

---

#### 5️⃣ `Module/`

> 迷你機器人區，每個主題對應一隻 bot，負責處理對話邏輯與整合 api + 話術

| 檔名                    | 對應主題                           |
| ----------------------- | ---------------------------------- |
| `miniBot-weather.js`    | 天氣查詢                           |
| `miniBot-air.js`        | 空氣品質查詢                       |
| `miniBot-earthquake.js` | 地震報告                           |
| `miniBot-holiday.js`    | 假日 / 放假日查詢                  |
| `miniBot-botgod.js`     | 全知全能話術處理區（故左右而言它） |
| `miniBot-dontKnow.js`   | 「窩不知道」系列                   |
| `miniBot-QA.js`         | 聊天型 QA                          |
| `miniBot.js`            | 主機器人邏輯總入口（index 調度用） |

---

#### 6️⃣ `MessageMockup/`

> 放所有 LINE Flex 或 template message 格式的訊息內容模版
> （未來可替代 `reply()` 中 hardcode 的訊息物件）

---

### 流程規劃

#### 🦧 使用者視角

```
使用者傳訊息
    ↓
index.js：收到並比對關鍵字
    ↓
派送給對應 miniBot
    ↓
miniBot：決定要串哪些 API，從 apiList 取出 URL 並呼叫
    ↓
Library 工具：處理回傳資料（格式化、轉成說人話）
    ↓
組裝成訊息樣板（搭配 data 裡的話術模板）
    ↓
送回 LINE 使用者顯示
```

#### 📊 資料視角

```
API/靜態 json（data/info）→ api/XXXApi.js 抓資料
    → 傳給 Library 工具（清洗、轉義、格式化）
    → 傳給 Module（加話術、判斷邏輯）
    → MessageMockup（決定格式）
    → 組裝完成 → 給 index.js 回傳給使用者
```

#### 資料處理工廠流水線

暫記↓
把資料抓下來之後，針對各資料處理

1. 最需要知道的資訊要拆出來
2. 知道api的結構
3. 知道想達成的效果
